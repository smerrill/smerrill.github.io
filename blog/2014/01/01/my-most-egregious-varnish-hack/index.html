<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Most Egregious Varnish Hack - Grenade Sandwich</title>
  <meta name="author" content="Steven W. Merrill">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://smerrill.github.io/blog/2014/01/01/my-most-egregious-varnish-hack">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Grenade Sandwich" type="application/atom+xml">

  <!-- Fira stylesheet -->
<link href="/assets/fonts/stylesheet.css" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<!-- <link href="/javascripts/libs/bootstrap-3.0.0/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css"> -->
<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/readable/bootstrap.min.css" rel="stylesheet" type="text/css">
<!--<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/journal/bootstrap.min.css" rel="stylesheet" type="text/css">-->
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<!-- Awesome font. -->
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <strong>
              <a class="navbar-brand" href="/">Grenade Sandwich</a>
            </strong>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/about-site/">About this Site</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right visible-xs visible-md visible-lg" action="http://google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:smerrill.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <article class="hentry" role="article">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-01T00:00:00-05:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
        
      </p>
    
    
    <h1 class="entry-title">
        My Most Egregious Varnish Hack
        
    </h1>
    
  </header>




<div class="entry-content clearfix"><p><a href="http://varnish-cache.org/">Varnish</a> is an amazing piece of open-source software. At <a href="http://treehouseagency.com">Treehouse Agency</a> we use it as a standard part of our hosting stack because of its amazing performance for serving anonymous and static content.</p>

<p>In truth, though, its extreme ease of configuration is another part of its appeal. Perhaps an application that you can&rsquo;t easily change is sending the wrong headers. In that case, just rewrite them on the way back out. Maybe you want to <a href="https://www.varnish-cache.org/trac/wiki/FAQ/Compression#Ithoughtyousaidthiswascomplicated">munge Accept-Encoding headers</a> to get maximum cache hit rates? Varnish handles that with aplomb.</p>

<p>My favorite Varnish story, though, deals with a quick hack I put together to fix what could potentially have been a major PR problem.</p>

<!-- break -->


<h2>Shortening Links For Fun and Profit</h2>

<p>We use <a href="http://bit.ly">bit.ly</a> to shorten <a href="http://treehouseagency.com">Treehouse Agency</a>&rsquo;s links. Specifically, we are using bit.ly&rsquo;s &ldquo;Custom short domain&rdquo; feature to use the <u>tha.cm</u> domain for all of our shortened links. We like bit.ly for its analytics and the fact that a custom short domain is free.</p>

<p>Now let&rsquo;s travel back in time a bit.</p>

<p>In the early spring of 2011, Team Treehouse Agency was preparing for <a href="http://chicago2011.drupal.org/">DrupalCon Chicago</a>. We had just printed up new business cards and promotional materials. We had put a number of URLs into our promotional materials and we were fleshing their content in the days leading up to the conference. One by one, we claimed the URLs on our tha.cm domain as we finished pages.</p>

<h2>&hellip;Oops</h2>

<p>We left the easiest page to produce (content-wise) for last: <a href="http://tha.cm/social">tha.cm/social</a>, which was simply a list of all the Treehouse Agency social media links. When we went to claim this link, however, we discovered one thing that we had overlooked.</p>

<p><strong>Using a bit.ly custom domain does not give you your own pool of unique links.</strong></p>

<p>Stated in another way, tha.cm/social is the same as bit.ly/social is the same as (insert other short domain here)/social, and someone had already claimed this. This was a major problem, because thousands of Treehouse Agency business cards had been printed with that exact link on it.</p>

<h2>Varnish to the rescue!</h2>

<p>We looked at other link-shortening services, but many of them cost too much or didn&rsquo;t offer the same level of analytics that we got from bit.ly. Without a simple switch possible, I implemented a quick 10-minute fix with Varnish.</p>

<p>The way that you implement bit.ly custom short domain support is by setting up a DNS <strong>A</strong> record that points to the URL 168.143.174.97. Therefore, I created a tiny <a href="http://www.rackspace.com/cloud/cloud_hosting_products/servers/">Rackspace Cloud Server</a> and set the DNS for tha.cm to resolve to its IP. I then installed Varnish on it, and configured it almost as a straight-up proxy. Here&rsquo;s the VCL I used:</p>

<div class="highlight"><pre><code class="scala"><span class="n">backend</span> <span class="n">default</span> <span class="o">{</span>
  <span class="o">.</span><span class="n">host</span> <span class="k">=</span> <span class="s">&quot;168.143.174.97&quot;</span><span class="o">;</span>
  <span class="o">.</span><span class="n">port</span> <span class="k">=</span> <span class="s">&quot;80&quot;</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">sub</span> <span class="n">vcl_recv</span> <span class="o">{</span>
  <span class="n">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">host</span> <span class="k">=</span> <span class="s">&quot;tha.cm&quot;</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s">&quot;/social&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">error</span> <span class="mi">750</span> <span class="s">&quot;Moved Temporarily&quot;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">sub</span> <span class="n">vcl_error</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">750</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">set</span> <span class="n">obj</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="nc">Location</span> <span class="k">=</span> <span class="s">&quot;http://tha.cm/tha-social&quot;</span><span class="o">;</span>
    <span class="n">set</span> <span class="n">obj</span><span class="o">.</span><span class="n">status</span> <span class="k">=</span> <span class="mi">302</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">deliver</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>It&rsquo;s really pretty simple. If the requested URL is &ldquo;/social&rdquo;, redirect to the real tha.cm/bit.ly link that we ended up getting. Otherwise, it proxies the request through to 168.143.174.97, which is the address that you would normally put into your domain&rsquo;s DNS anyway.</p>

<p>Varnish&rsquo;s primary role is that of a super-fast reverse proxy cache, but hopefully this post has also shown you that its flexibility can also save you from other sorts of issues.</p>

<p>In our case, it meant that we didn&rsquo;t have to reprint lots of business cards. Chalk up another win for Varnish.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard">Posted by <span class="fn">Steven W. Merrill</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-01T00:00:00-05:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/hackery/'>hackery</a>, <a class='category' href='/blog/categories/varnish/'>varnish</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://smerrill.github.io/blog/2014/01/01/my-most-egregious-varnish-hack/" data-via="stevenmerrill" data-counturl="http://smerrill.github.io/blog/2014/01/01/my-most-egregious-varnish-hack/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/2014/01/01/everything-old-is-new-hotness/" title="Previous Post: Back to the Future (Or, "A Neckbeard's Progress")">&laquo; Back to the Future (Or, "A Neckbeard's Progress")</a></li>
            
            
            <li class="next"><a href="/blog/2014/01/01/setting-up-a-lionamp-stack/" title="Next Post: Setting Up Your L(ion)AMP Stack">Setting Up Your L(ion)AMP Stack &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2020/01/01/template/">Title</a>
    
    <a class="list-group-item " href="/blog/2014/05/26/combining-tasks-with-grunt/">Combining Tasks With Grunt</a>
    
    <a class="list-group-item " href="/blog/2014/01/01/ten-lesser-known-things-about-vagrant/">Ten Lesser-Known Things About Vagrant</a>
    
    <a class="list-group-item " href="/blog/2014/01/01/setting-up-your-lionamp-stack/">Setting Up Your L(ion)AMP Stack</a>
    
    <a class="list-group-item " href="/blog/2014/01/01/setting-up-a-lionamp-stack/">Setting Up Your L(ion)AMP Stack</a>
    
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Popular Categories</h3>
  </div>
  <div class="list-group">
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/conference/index.html">
      <span class="badge">2</span>
      conference
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/theming/index.html">
      <span class="badge">2</span>
      theming
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/drupal/index.html">
      <span class="badge">18</span>
      drupal
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/planet-drupal/index.html">
      <span class="badge">4</span>
      planet drupal
    </a>
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/development/index.html">
      <span class="badge">9</span>
      development
    </a>
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/performance/index.html">
      <span class="badge">6</span>
      performance
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/views/index.html">
      <span class="badge">2</span>
      views
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/treehouse-agency/index.html">
      <span class="badge">3</span>
      treehouse agency
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/presentations/index.html">
      <span class="badge">8</span>
      presentations
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/web-development/index.html">
      <span class="badge">4</span>
      web development
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/centos/index.html">
      <span class="badge">2</span>
      centos
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/scala/index.html">
      <span class="badge">3</span>
      scala
    </a>
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/scala-2.7/index.html">
      <span class="badge">3</span>
      scala 2.7
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/browsers/index.html">
      <span class="badge">2</span>
      browsers
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/varnish/index.html">
      <span class="badge">2</span>
      varnish
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/vagrant/index.html">
      <span class="badge">6</span>
      vagrant
    </a>
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/virtualbox/index.html">
      <span class="badge">2</span>
      virtualbox
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/irc/index.html">
      <span class="badge">2</span>
      irc
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/veewee/index.html">
      <span class="badge">2</span>
      veewee
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/drupal-planet/index.html">
      <span class="badge">3</span>
      drupal planet
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/virtualization/index.html">
      <span class="badge">4</span>
      virtualization
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="list-group-item " href="/blog/categories/php/index.html">
      <span class="badge">2</span>
      php
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating...</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/smerrill">@smerrill</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'smerrill',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2009 - 2014 by Steven W. Merrill<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/javascripts/libs/bootstrap-3.0.0/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>








  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </body>
</html>
