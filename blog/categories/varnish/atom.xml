<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: varnish | Grenade Sandwich]]></title>
  <link href="http://smerrill.github.io/blog/categories/varnish/atom.xml" rel="self"/>
  <link href="http://smerrill.github.io/"/>
  <updated>2014-05-27T09:21:44-04:00</updated>
  <id>http://smerrill.github.io/</id>
  <author>
    <name><![CDATA[Steven W. Merrill]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[My Most Egregious Varnish Hack]]></title>
    <link href="http://smerrill.github.io/blog/2014/01/01/my-most-egregious-varnish-hack/"/>
    <updated>2014-01-01T00:00:00-05:00</updated>
    <id>http://smerrill.github.io/blog/2014/01/01/my-most-egregious-varnish-hack</id>
    <content type="html"><![CDATA[<p><a href="http://varnish-cache.org/">Varnish</a> is an amazing piece of open-source software. At <a href="http://treehouseagency.com">Treehouse Agency</a> we use it as a standard part of our hosting stack because of its amazing performance for serving anonymous and static content.</p>

<p>In truth, though, its extreme ease of configuration is another part of its appeal. Perhaps an application that you can&rsquo;t easily change is sending the wrong headers. In that case, just rewrite them on the way back out. Maybe you want to <a href="https://www.varnish-cache.org/trac/wiki/FAQ/Compression#Ithoughtyousaidthiswascomplicated">munge Accept-Encoding headers</a> to get maximum cache hit rates? Varnish handles that with aplomb.</p>

<p>My favorite Varnish story, though, deals with a quick hack I put together to fix what could potentially have been a major PR problem.</p>

<!-- break -->


<h2>Shortening Links For Fun and Profit</h2>

<p>We use <a href="http://bit.ly">bit.ly</a> to shorten <a href="http://treehouseagency.com">Treehouse Agency</a>&rsquo;s links. Specifically, we are using bit.ly&rsquo;s &ldquo;Custom short domain&rdquo; feature to use the <u>tha.cm</u> domain for all of our shortened links. We like bit.ly for its analytics and the fact that a custom short domain is free.</p>

<p>Now let&rsquo;s travel back in time a bit.</p>

<p>In the early spring of 2011, Team Treehouse Agency was preparing for <a href="http://chicago2011.drupal.org/">DrupalCon Chicago</a>. We had just printed up new business cards and promotional materials. We had put a number of URLs into our promotional materials and we were fleshing their content in the days leading up to the conference. One by one, we claimed the URLs on our tha.cm domain as we finished pages.</p>

<h2>&hellip;Oops</h2>

<p>We left the easiest page to produce (content-wise) for last: <a href="http://tha.cm/social">tha.cm/social</a>, which was simply a list of all the Treehouse Agency social media links. When we went to claim this link, however, we discovered one thing that we had overlooked.</p>

<p><strong>Using a bit.ly custom domain does not give you your own pool of unique links.</strong></p>

<p>Stated in another way, tha.cm/social is the same as bit.ly/social is the same as (insert other short domain here)/social, and someone had already claimed this. This was a major problem, because thousands of Treehouse Agency business cards had been printed with that exact link on it.</p>

<h2>Varnish to the rescue!</h2>

<p>We looked at other link-shortening services, but many of them cost too much or didn&rsquo;t offer the same level of analytics that we got from bit.ly. Without a simple switch possible, I implemented a quick 10-minute fix with Varnish.</p>

<p>The way that you implement bit.ly custom short domain support is by setting up a DNS <strong>A</strong> record that points to the URL 168.143.174.97. Therefore, I created a tiny <a href="http://www.rackspace.com/cloud/cloud_hosting_products/servers/">Rackspace Cloud Server</a> and set the DNS for tha.cm to resolve to its IP. I then installed Varnish on it, and configured it almost as a straight-up proxy. Here&rsquo;s the VCL I used:</p>

<p><div class="highlight"><pre><code class="scala"><span class="n">backend</span> <span class="n">default</span> <span class="o">{</span>
  <span class="o">.</span><span class="n">host</span> <span class="k">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mf">168.143</span><span class="o">.</span><span class="mf">174.97</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;;</span>
  <span class="o">.</span><span class="n">port</span> <span class="k">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mi">80</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;;</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">sub</span> <span class="n">vcl_recv</span> <span class="o">{</span>
  <span class="n">set</span> <span class="n">req</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">host</span> <span class="k">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">tha</span><span class="o">.</span><span class="n">cm</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;/</span><span class="n">social</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">error</span> <span class="mi">750</span> <span class="s">&quot;Moved Temporarily&quot;</span><span class="o">;</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">}</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">sub</span> <span class="n">vcl_error</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">750</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">set</span> <span class="n">obj</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="nc">Location</span> <span class="k">=</span> <span class="s">&quot;http://tha.cm/tha-social&quot;</span><span class="o">;</span>
<span class="n">set</span> <span class="n">obj</span><span class="o">.</span><span class="n">status</span> <span class="k">=</span> <span class="mi">302</span><span class="o">;</span>
<span class="k">return</span> <span class="o">(</span><span class="n">deliver</span><span class="o">);</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></p>

<p>It&rsquo;s really pretty simple. If the requested URL is &ldquo;/social&rdquo;, redirect to the real tha.cm/bit.ly link that we ended up getting. Otherwise, it proxies the request through to 168.143.174.97, which is the address that you would normally put into your domain&rsquo;s DNS anyway.</p>

<p>Varnish&rsquo;s primary role is that of a super-fast reverse proxy cache, but hopefully this post has also shown you that its flexibility can also save you from other sorts of issues.</p>

<p>In our case, it meant that we didn&rsquo;t have to reprint lots of business cards. Chalk up another win for Varnish.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Coat Your Website in Varnish]]></title>
    <link href="http://smerrill.github.io/blog/2011/07/13/coat-your-website-in-varnish/"/>
    <updated>2011-07-13T00:00:00-04:00</updated>
    <id>http://smerrill.github.io/blog/2011/07/13/coat-your-website-in-varnish</id>
    <content type="html"><![CDATA[<p>Last week at the <a href="http://groups.drupal.org/nyc/">Drupal NYC meetup</a>, I gave a presentation about <a href="http://varnish-cache.org/">the Varnish reverse proxy cache</a>.</p>


<p></p></p>

<!--more-->




<p><!--break--></p>


<p></p></p>

<p>If you happened to be at the meetup, I'd love your feedback on the talk. Please fill out a quick review on SpeakerRate here: <a href="http://tha.cm/varnish-talk" title="http://tha.cm/varnish-talk">http://tha.cm/varnish-talk</a></p>


<p></p></p>

<p>In addition, I've <a href="http://www.drupaldelphia.com/sessions/coat-your-website-varnish">proposed a similar session</a> for <a href="http://www.drupaldelphia.com/">Drupaldelphia</a> that will take a deeper dive into Varnish and show some examples of its use, including using the command line tools and VCL configuration examples.</p>


<p></p></p>

<p>The full presentation is embedded below.</p>


<p></p></p>

<div class="prezi-player">
<style type="text/css" media="screen">.prezi-player { width: 550px; } .prezi-player-links { text-align: center; }</style><object id="prezi_fiifbaoxj0za" name="prezi_fiifbaoxj0za" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="550" height="400"><param name="movie" value="http://prezi.com/bin/preziloader.swf" /><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="prezi_id=fiifbaoxj0za&lock_to_path=1&color=ffffff&autoplay=no&autohide_ctrls=0" /><embed id="preziEmbed_fiifbaoxj0za" name="preziEmbed_fiifbaoxj0za" src="http://prezi.com/bin/preziloader.swf" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="550" height="400" bgcolor="#ffffff" flashvars="prezi_id=fiifbaoxj0za&lock_to_path=1&color=ffffff&autoplay=no&autohide_ctrls=0"></embed></object>
<div class="prezi-player-links">
<p><a title="Why you should consider Varnish to make your Drupal website FAST." href="http://prezi.com/fiifbaoxj0za/coat-your-website-in-varnish/">Coat Your Website in Varnish</a> on <a href="http://prezi.com">Prezi</a></p><br />
</div><br />
</div>


<p></p></p>
]]></content>
  </entry>
  
</feed>
